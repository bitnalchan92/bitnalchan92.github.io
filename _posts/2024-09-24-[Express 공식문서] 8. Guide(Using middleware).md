---
title: "[Express ê³µì‹ë¬¸ì„œ] 8. Guide(Using middleware)"
description: "https://expressjs.com/en/guide/using-middleware.html"
date: 2024-09-24
categories: [express, ê³µì‹ê°€ì´ë“œ]
tags: [express guide, middleware]
---



> [https://expressjs.com/en/guide/using-middleware.html](https://expressjs.com/en/guide/using-middleware.html)
{: .prompt-tip }



# Using Middleware

ExpressëŠ” ìµœì†Œí•œì˜ ìì²´ì ì¸ ê¸°ëŠ¥ì„ ê°€ì§„ ë¼ìš°íŒ…ê³¼ ë¯¸ë“¤ì›¨ì–´ ì›¹ í”„ë ˆì„ì›Œí¬ì…ë‹ˆë‹¤. Express ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ê¸°ë³¸ì ìœ¼ë¡œ ì¼ë ¨ì˜ ë¯¸ë“¤ì›¨ì–´ ê¸°ëŠ¥ì˜ í˜¸ì¶œì…ë‹ˆë‹¤. 



`Middleware function`ì€ ìš”ì²­-ì‘ë‹µ ì£¼ê¸° ë‚´ë¶€ì˜ ìš”ì²­ ê°ì²´(`req`), ì‘ë‹µ ê°ì²´(`res`) ê·¸ë¦¬ê³  `next middleware function`ì— ì§ì ‘ì ìœ¼ë¡œ ì•¡ì„¸ìŠ¤ í•  ìˆ˜ ìˆëŠ” functionì…ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ `next middleware function`(ë‹¤ìŒì— ìˆ˜í–‰ë˜ì–´ì§ˆ middlewareë¥¼ ì˜ë¯¸)ì€ `next`ë¼ëŠ” ë³€ìˆ˜ë¡œ í‘œì‹œë©ë‹ˆë‹¤.



Middleware functionì€ ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- Execute any code. ëª¨ë“  ì½”ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. 
- Make changes to the request and the response objects. ìš”ì²­ ë° ì‘ë‹µ ê°ì²´ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
- End the request-response cycle. ìš”ì²­-ì‘ë‹µ ì£¼ê¸°ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤. 
- Call the next middleware function in the stack. ìŠ¤íƒì—ì„œ ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.



í˜„ì¬ ìˆ˜í–‰ì¤‘ì¸ Middleware functionì´ ìš”ì²­-ì‘ë‹µ ì£¼ê¸°ë¥¼ ì¢…ë£Œí•˜ì§€ ì•Šìœ¼ë©´ `next()`ë¥¼ í˜¸ì¶œí•˜ì—¬ ë‹¤ìŒì— ìˆ˜í–‰ë  Middleware functionì—ê²Œ ì œì–´ê¶Œì„ ë„˜ê²¨ì•¼ í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ìš”ì²­ì´ ì¤‘ë‹¨ëœ ìƒíƒœë¡œ "ìœ ì§€(will be left hanging)"ë©ë‹ˆë‹¤.



Express ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ë‹¤ìŒ ìœ í˜•ì˜ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- Application-level middleware (ì• í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ì¤€ ë¯¸ë“¤ì›¨ì–´)
- Router-level middleware (ë¼ìš°í„° ìˆ˜ì¤€ ë¯¸ë“¤ì›¨ì–´)
- Error-handling middleware (ì˜¤ë¥˜ ì²˜ë¦¬ ë¯¸ë“¤ì›¨ì–´)
- Built-in middleware (ë‚´ì¥ ë¯¸ë“¤ì›¨ì–´)
- Third-party middleware (íƒ€ì‚¬ ë¯¸ë“¤ì›¨ì–´)



ì„ íƒì  ë§ˆìš´íŠ¸ ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ì¤€ ë° ë¼ìš°í„° ìˆ˜ì¤€ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¼ë ¨ì˜ Middleware Functionì„ í•¨ê»˜ ë¡œë“œí•˜ì—¬ ë§ˆìš´íŠ¸ ì§€ì ì— ë¯¸ë“¤ì›¨ì–´ ì‹œìŠ¤í…œì˜ í•˜ìœ„ ìŠ¤íƒì„ ìƒì„±í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. 

> ì–´ë µë„¤... ë­”ë§ì´ì§€... ã…‹ã…‹ã…‹ ì¢€ë” ì‚´í´ë³´ì. í•˜ë‚˜ì˜ íŒŒì¼ë¡œ ë¹„ìŠ·í•œ ì—­í• ì„ í•˜ëŠ” middlewareë¥¼ ë¬¶ì–´ì„œ index.jsì—ì„œ ë¡œë“œí• ë•Œ ìˆœì„œë¥¼ ì •í•´ í•„ìš”í•œëŒ€ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ë§ì¸ê°€?



## <br>Application-level middleware

Express.js ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ, `app.use()` ë° `app.METHOD()` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ì¤€ ë¯¸ë“¤ì›¨ì–´ë¥¼ app ê°ì²´ ì¸ìŠ¤í„´ìŠ¤ì— ë°”ì¸ë”©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œ `METHOD`ëŠ” ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” HTTP ë©”ì„œë“œ(ì˜ˆ: GET, PUT ë˜ëŠ” POST)ë¥¼ ì†Œë¬¸ìë¡œ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.



ì•„ë˜ ì˜ˆì œì—ì„œëŠ” ë§ˆìš´íŠ¸ ê²½ë¡œê°€ ì—†ëŠ” ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤. ì´ í•¨ìˆ˜ëŠ” ì•±ì´ ìš”ì²­ì„ ë°›ì„ë•Œë§ˆë‹¤ ì‹¤í–‰ë©ë‹ˆë‹¤.

```javascript
const express = require('express')
const app = express()

app.use((req, res, next) => {
  console.log('Time: ', Date.now())
  next()
})
```

<br>

>âœ¨ ë§ˆìš´íŠ¸ ê²½ë¡œê°€ ì—†ëŠ” ë¯¸ë“¤ì›¨ì–´
>
>- ë§ˆìš´íŠ¸ ê²½ë¡œëŠ” ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ë  ê²½ë¡œë¥¼ ì§€ì •í•˜ëŠ” ë¶€ë¶„ì„ ì˜ë¯¸í•œë‹¤. ë¯¸ë“¤ì›¨ì–´ë¥¼ íŠ¹ì • ê²½ë¡œì— ë§ˆìš´íŠ¸í•˜ë©´, í•´ë‹¹ ê²½ë¡œë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì— ëŒ€í•´ì„œë§Œ ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ë˜ê³  ê·¸ ë°˜ëŒ€ë¡œ, ë§ˆìš´íŠ¸ ê²½ë¡œë¥¼ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ ëª¨ë“  ê²½ë¡œì— ëŒ€í•´ì„œ ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ëœë‹¤.
>- ì˜ˆë¥¼ ë“¤ì–´ì„œ, `/api`ê²½ë¡œì— ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§ˆìš´íŠ¸í•˜ë©´, `/api`ë¡œ ì‹œì‘í•˜ëŠ” ìš”ì²­ì— ëŒ€í•´ì„œë§Œ ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ëœë‹¤. 
>
>```javascript
>const express = require('express');
>const app = express();
>
>// ë§ˆìš´íŠ¸ ê²½ë¡œê°€ ì—†ëŠ” ë¯¸ë“¤ì›¨ì–´
>app.use((req, res, next) => {
>  console.log('Request received at:', new Date().toISOString());
>  next();
>});
>
>app.get('/', (req, res) => {
>  res.send('Hello World!');
>});
>
>app.listen(3000, () => {
>  console.log('Server is running on port 3000');
>});
>```
>
>ì´ ì˜ˆì œì—ì„œëŠ” ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ëœë‹¤. 

<br>

>âœ¨ ë§ˆìš´íŠ¸ ê²½ë¡œê°€ ìˆëŠ” ë¯¸ë“¤ì›¨ì–´
>
>- ì•„ë˜ ì˜ˆì œì—ì„œëŠ” `/api`ê²½ë¡œì— ë¯¸ë“¤ì›¨ì–´ê°€ ë§ˆìš´íŠ¸ ëœê²ƒì„ ë³¼ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ ì•„ë˜ì˜ ê²½ìš°ì—ëŠ” `/api`ë¡œ ì‹œì‘í•˜ëŠ” ìš”ì²­ì— ëŒ€í•´ì„œë§Œ ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ë˜ëŠ” ê²ƒì´ë‹¤.
>
>```javascript
>const express = require('express');
>const app = express();
>
>// `/api` ê²½ë¡œì— ë§ˆìš´íŠ¸ëœ ë¯¸ë“¤ì›¨ì–´
>app.use('/api', (req, res, next) => {
>  console.log('API Request received at:', new Date().toISOString());
>  next();
>});
>
>app.get('/api/data', (req, res) => {
>  res.send('Some API data');
>});
>
>app.get('/', (req, res) => {
>  res.send('Hello World!');
>});
>
>app.listen(3000, () => {
>  console.log('Server is running on port 3000');
>});
>```



ì´ ì˜ˆëŠ” `/user/:id` ê²½ë¡œì— ë§ˆìš´íŠ¸ëœ ë¯¸ë“¤ì›¨ì–´ ê¸°ëŠ¥ì„ ë³´ì—¬ì¤ë‹ˆë‹¤. ì´ í•¨ìˆ˜ëŠ” `/user/:id`ê²½ë¡œë¡œ ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  HTTPìš”ì²­ì— ëŒ€í•´ ì‹¤í–‰ë©ë‹ˆë‹¤.

```javascript
app.use('/user/:id', (req, res, next) => {
  console.log('Request Type : ', req.method)
  next()
})
```



ì´ ì˜ˆì—ì„œëŠ” Routeì™€ í•´ë‹¹í•˜ëŠ” í•¸ë“¤ëŸ¬í•¨ìˆ˜(ë¯¸ë“¤ì›¨ì–´ ì‹œìŠ¤í…œ)ì„ ë³´ì—¬ì¤ë‹ˆë‹¤. ì´ í•¨ìˆ˜ëŠ” `/user/:id` ê²½ë¡œì— ëŒ€í•œ GET ìš”ì²­ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. ( ì•„ë˜ ì˜ˆì œëŠ” `/user/:id`ê²½ë¡œë¡œ ë“¤ì–´ì˜¤ëŠ” GETìš”ì²­ì— ëŒ€í•´ì„œ í•´ë‹¹ ê²½ë¡œë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¸ë“¤ëŸ¬ í•¨ìˆ˜ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤. `:id`ëŠ” URL íŒŒë¼ë¯¸í„°ë¡œì„œ, ìš”ì²­ ê²½ë¡œì—ì„œ ì‚¬ìš©ìì˜ IDë¥¼ ì¶”ì¶œí•˜ì—¬ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. )

```javascript
const express = require('express')
const app = express()
const port = 3000

app.get('/user/:id', (req, res) => {
  const userId = req.params.id;
  
  res.send(`User ID : ${userId}`)
})

app.listen(port, () => {
	console.log(`Express is running on port ${port}`)
})
```



ë‹¤ìŒì€ ë§ˆìš´íŠ¸ ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ì—¬ ë§ˆìš´íŠ¸ ì§€ì ì— ì¼ë ¨(a series of)ì˜ ë¯¸ë“¤ì›¨ì–´ ê¸°ëŠ¥ì„ ë¡œë“œí•˜ëŠ” ì˜ˆì…ë‹ˆë‹¤. ì´ëŠ” ëª¨ë“  ìœ í˜•ì˜ HTTP ìš”ì²­ì— ëŒ€í•œ ìš”ì²­ ì •ë³´ë¥¼ ì¶œë ¥í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ ì„œë¸Œ ìŠ¤íƒì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

```javascript
app.use('/user/:id', (req, res, next) => {
  console.log('Request URL : ', req.originalUrl)
  next()
}, (req, res, next) => {
  console.log('Request Type : ', req.method)
  next()
})
```



`Route Handler`ëŠ” ê²½ë¡œì— ëŒ€í•´ ì—¬ëŸ¬ ê°œì˜ `Route`ë¥¼ ì •ì˜í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì•„ë˜ ì˜ˆì œëŠ” `/user/:id` ê²½ë¡œì— ëŒ€í•œ GET ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë‘ ê°œì˜ ë¼ìš°íŠ¸ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ë‘ ë²ˆì§¸ ë¼ìš°íŠ¸ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•Šì§€ë§Œ, ì²« ë²ˆì§¸ ë¼ìš°íŠ¸ê°€ ìš”ì²­-ì‘ë‹µ ì‚¬ì´í´ì„ ëë‚´ê¸° ë•Œë¬¸ì— í˜¸ì¶œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì´ ì˜ˆì œëŠ” `/user/:id`ê²½ë¡œì— ëŒ€í•œ GET ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ ì„œë¸ŒìŠ¤íƒì„ ë³´ì—¬ì¤ë‹ˆë‹¤. 

```javascript
app.get('/user/:id', (req, res, next) => {
  console.log('ID:', req.params.id)
  next()
}, (req, res, next) => {
  res.send('User Info')
})

// handler for the /user/:id path, which prints the user ID
app.get('/user/:id', (req, res, next) => {
  res.send(req.params.id)
})
```



### <br>middleware sub-stack?

> ë¯¸ë“¤ì›¨ì–´ ì„œë¸ŒìŠ¤íƒì˜ ì˜ë¯¸ê°€ ì˜ ì•ˆì¡í˜€ì„œ gptì—ê²Œ ë¬¼ì–´ë´¤ë‹¤...

ë¯¸ë“¤ì›¨ì–´ ì„œë¸ŒìŠ¤íƒ(Middleware sub-stack)ì€ íŠ¹ì • ê²½ë¡œì— ëŒ€í•´ì„œ ì—¬ëŸ¬ ê°œì˜ ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ë“¤ì„ ê³„ì¸µì ìœ¼ë¡œ êµ¬ì„±í•˜ì—¬ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì„œë¸ŒìŠ¤íƒì€ ì£¼ì–´ì§„ ê²½ë¡œì—ì„œ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ë•Œ ê° ë¯¸ë“¤ì›¨ì–´ê°€ ì°¨ë¡€ëŒ€ë¡œ í˜¸ì¶œë˜ì–´ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê³ , ë§ˆì§€ë§‰ìœ¼ë¡œ ì‹¤ì œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.



ì´ë ‡ê²Œ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì„œë¸ŒìŠ¤íƒìœ¼ë¡œ êµ¬ì„±í•˜ë©´ ì½”ë“œì˜ ëª¨ë“ˆí™”ì™€ ì¬ì‚¬ìš©ì„±ì„ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ë“¤ì–´, íŠ¹ì • ê²½ë¡œì—ì„œ ì¸ì¦, ë¡œê¹…, ë°ì´í„° ê²€ì¦ ë“±ì„ ì²˜ë¦¬í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ë“¤ì„ í•˜ë‚˜ì˜ ì„œë¸ŒìŠ¤íƒìœ¼ë¡œ ë¬¶ì–´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 



ì•„ë˜ëŠ” `/user/:id`ê²½ë¡œì— ëŒ€í•œ ë¯¸ë“¤ì›¨ì–´ ì„œë¸ŒìŠ¤íƒì˜ ì˜ˆì…ë‹ˆë‹¤.

```javascript
const express = require('express');
const app = express();

// ìš”ì²­ ì •ë³´ë¥¼ ë¡œê¹…í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ (ğŸ¤— ì²«ë²ˆì§¸ë¡œ ìˆ˜í–‰ë  ë¯¸ë“¤ì›¨ì–´)
const logRequestInfo = (req, res, next) => {
    console.log(`ë©”ì†Œë“œ: ${req.method}`);
    console.log(`ê²½ë¡œ: ${req.path}`);
    console.log(`ì¿¼ë¦¬: ${JSON.stringify(req.query)}`);
    console.log(`ë³¸ë¬¸: ${JSON.stringify(req.body)}`);
    next(); // ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ ë˜ëŠ” ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ë¡œ ì§„í–‰
};

// ì‚¬ìš©ì ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ (ğŸ¤— ë‘ë²ˆì§¸ë¡œ ìˆ˜í–‰ë  ë¯¸ë“¤ì›¨ì–´)
const authenticateUser = (req, res, next) => {
    // ì¸ì¦ ë¡œì§ êµ¬í˜„
    next();
};

// /user/:idì— ëŒ€í•œ ë¯¸ë“¤ì›¨ì–´ ì„œë¸ŒìŠ¤íƒ
const userMiddleware = express.Router();

userMiddleware.use(logRequestInfo);
userMiddleware.use(authenticateUser);

// ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬
userMiddleware.get('/:id', (req, res) => {
    res.send(`User ID: ${req.params.id}`);
});

// ë¯¸ë“¤ì›¨ì–´ ì„œë¸ŒìŠ¤íƒì„ /user ê²½ë¡œì— ë§ˆìš´íŠ¸
app.use('/user', userMiddleware);

// ì„œë²„ ì‹œì‘
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`ì„œë²„ê°€ í¬íŠ¸ ${PORT}ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.`);
});

```

ìœ„ ì˜ˆì œì—ì„œ `useMiddleware`ëŠ” `/user/:id` ê²½ë¡œì— ëŒ€í•œ ë¯¸ë“¤ì›¨ì–´ ì„œë¸ŒìŠ¤íƒìœ¼ë¡œ, `logRequestInfo`ì™€ `authenticateUser` ë¯¸ë“¤ì›¨ì–´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤. ì´ ì„œë¸ŒìŠ¤íƒì€ `/user` ê²½ë¡œì— ë§ˆìš´íŠ¸ë˜ì–´, í•´ë‹¹ ê²½ë¡œë¡œ ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ ìˆœì°¨ì ìœ¼ë¡œ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.



#### express.Router() ì—­í•  ( ìœ„ì˜ ì˜ˆì œì˜ 20í–‰ ì°¸ê³ ! )

- `express.Router()`ëŠ” Express.jsì—ì„œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ìœ¼ë¡œ, ë¼ìš°íŠ¸ë¥¼ ëª¨ë“ˆí™”í•˜ê³  ì—¬ëŸ¬ ê²½ë¡œë¥¼ ê·¸ë£¹í™”!í•˜ëŠ”ë° ì‚¬ìš©ëœë‹¤. ì´ëŠ” ì½”ë“œë¥¼ ë” ê¹”ë”í•˜ê³  ê´€ë¦¬í•˜ê¸° ì‰½ê²Œ ë§Œë“¤ì–´ì¤€ë‹¤. `express.Router()`ë¥¼ ì‚¬ìš©í•˜ë©´ ì—¬ëŸ¬ ë¼ìš°íŠ¸ì™€ ë¯¸ë“¤ì›¨ì–´ë¥¼ í•˜ë‚˜ì˜ ë¼ìš°í„° ì¸ìŠ¤í„´ìŠ¤ì— ì •ì˜í•˜ê³ , ì´ë¥¼ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ íŠ¹ì • ê²½ë¡œì— ë§ˆìš´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

	1. **ëª¨ë“ˆí™”** : ë¼ìš°íŠ¸ë¥¼ ì‘ì€ ëª¨ë“ˆë¡œ ë¶„ë¦¬í•˜ì—¬ ì½”ë“œì˜ ê°€ë…ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„±ì„ ë†’ì…ë‹ˆë‹¤.
	1. **ì¤‘ì²© ë¼ìš°íŠ¸** : ë¼ìš°íŠ¸ë¥¼ ì¤‘ì²©í•˜ì—¬ ê³„ì¸µ êµ¬ì¡°ë¡œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ íŠ¹ì • ê²½ë¡œì— ëŒ€í•´ ì—¬ëŸ¬ ë¯¸ë“¤ì›¨ì–´ì™€ ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
	1. **ë¯¸ë“¤ì›¨ì–´ ê·¸ë£¹í™”** : íŠ¹ì • ê²½ë¡œì— ëŒ€í•´ ì—¬ëŸ¬ ë¯¸ë“¤ì›¨ì–´ë¥¼ ê·¸ë£¹í™”í•˜ì—¬ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.



<br>

ë¼ìš°í„° ë¯¸ë“¤ì›¨ì–´ ìŠ¤íƒì—ì„œ ë‚˜ë¨¸ì§€ ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ë¥¼ ê±´ë„ˆë›°ë ¤ë©´ `next('route')`ë¥¼ í˜¸ì¶œí•˜ì—¬ ì œì–´ë¥¼ ë‹¤ìŒ ê²½ë¡œë¡œ ì „ë‹¬í•˜ì„¸ìš”. 

**ì°¸ê³ ** : `next('route')`ëŠ” ì˜¤ì§ `app.METHOD()` ë˜ëŠ” `router.METHOD()` í•¨ìˆ˜ì— ì˜í•´ ë¡œë“œëœ ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤.



ì´ ì˜ˆëŠ” `/user/:id`ê²½ë¡œì— ëŒ€í•œ  GET ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ ì„œë¸ŒìŠ¤íƒì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

```javascript 
/*
if (req.params.id === '0') next('route')ëŠ” Express.jsì—ì„œ ì‚¬ìš©ë˜ëŠ” íŠ¹ìˆ˜í•œ next í•¨ìˆ˜ í˜¸ì¶œë¡œ, í˜„ì¬ ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ê±´ë„ˆë›°ê³  ë‹¤ìŒ ê²½ë¡œë¡œ ì´ë™í•˜ë„ë¡ í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ ì½”ë“œëŠ” íŠ¹ì • ì¡°ê±´(ì—¬ê¸°ì„œëŠ” req.params.idê°€ '0'ì¸ ê²½ìš°)ì— ë”°ë¼ í˜„ì¬ í•¸ë“¤ëŸ¬ë¥¼ ê±´ë„ˆë›°ê³  ë‹¤ìŒ ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ë¡œ ì œì–´ë¥¼ ë„˜ê¸°ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
*/
app.get('/user/:id', (req, res, next) => {
  // if the user ID is 0, skip to the next route
  if (req.params.id === '0') next('route')
  // otherwise pass the control to the next middleware function in this stack
  else next()
}, (req, res, next) => {
  // send a regular response
  res.send('regular')
})

// handler for the /user/:id path, which sends a special response
app.get('/user/:id', (req, res, next) => {
  res.send('special')
})
```



<br>

ì¬ì‚¬ìš©ì„ ìœ„í•´ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë°°ì—´ë¡œ ì„ ì–¸í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

ì´ ì˜ˆëŠ” `/user/:id`ê²½ë¡œì— ëŒ€í•œ GETìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ ì„œë¸ŒìŠ¤íƒì´ ìˆëŠ” ë°°ì—´ì„ ë³´ì—¬ì¤ë‹ˆë‹¤. 

```javascript
function logOriginalUrl (req, res, next) {
  console.log('Request URL : ', req.originalUrl)
  next()
}

function logMethod (req, res, next) {
  console.log('Request Type : ', req.method)
  next()
}

const logStuff = [logOriginalUrl, logMethod]

app.get('/user/:id', logStuff, (req, res, next) => {
  res.send('User Info')
})
```



## <br>Router-level middleware

ë¼ìš°í„° ìˆ˜ì¤€ì˜ ë¯¸ë“¤ì›¨ì–´ëŠ” `express.Router()` ì¸ìŠ¤í„´ìŠ¤ì— ë°”ì¸ë”© ëœë‹¤ëŠ” ì ì„ ì œì™¸í•˜ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ì¤€ì˜ ë¯¸ë“¤ì›¨ì–´ì™€ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.

```javascript
const router = express.Router();
```



`router.use()` ë° `router.METHOD()` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ ë¼ìš°í„° ìˆ˜ì¤€ì˜ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤. 



ë‹¤ìŒ ì˜ˆì œ ì½”ë“œëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ì¤€ì˜ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë¼ìš°í„° ìˆ˜ì¤€ì˜ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¬í˜„í•œ ê²ƒì…ë‹ˆë‹¤.

```javascript
const express = require('express')
const app = express()
const router = express.Router()

// ë§ˆìš´íŠ¸ ê²½ë¡œê°€ ì—†ëŠ” ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜. ì´ ì½”ë“œëŠ” ë¼ìš°í„°ì— ëŒ€í•œ ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ ì‹¤í–‰ë©ë‹ˆë‹¤.
router.use((req, res, next) => {
  console.log('Time:', Date.now())
  next()
})

// /user/:id ê²½ë¡œì— ëŒ€í•œ ëª¨ë“  HTTP ìš”ì²­ì˜ ìš”ì²­ ì •ë³´ë¥¼ ì¶œë ¥í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ ì„œë¸Œ ìŠ¤íƒ
router.use('/user/:id', (req, res, next) => {
  console.log('Request URL:', req.originalUrl)
  next()
}, (req, res, next) => {
  console.log('Request Type:', req.method)
  next()
})

// /user/:id ê²½ë¡œì— ëŒ€í•œ GET ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ ì„œë¸Œ ìŠ¤íƒ
router.get('/user/:id', (req, res, next) => {
  // user IDê°€ 0ì¸ ê²½ìš°, ë‹¤ìŒ ë¼ìš°í„°ë¡œ ê±´ë„ˆëœë‹ˆë‹¤.
  if (req.params.id === '0') next('route')
  // ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì´ ìŠ¤íƒì˜ ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ë¡œ ì œì–´ë¥¼ ë„˜ê¹ë‹ˆë‹¤.
  else next()
}, (req, res, next) => {
  // ì¼ë°˜ í˜ì´ì§€ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
  res.render('regular')
})

// /user/:id ê²½ë¡œì— ëŒ€í•œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ì—¬ íŠ¹ë³„í•œ í˜ì´ì§€ë¥¼ ë Œë”ë§í•˜ëŠ” í•¸ë“¤ëŸ¬
router.get('/user/:id', (req, res, next) => {
  console.log(req.params.id)
  res.render('special')
})

// ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë¼ìš°í„°ë¥¼ ë§ˆìš´íŠ¸
app.use('/', router)
```



ë¼ìš°í„°ì˜ ë‚˜ë¨¸ì§€ ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ë¥¼ ê±´ë„ˆë›°ë ¤ë©´ `next('router')`ë¥¼ í˜¸ì¶œí•˜ì—¬ ë¼ìš°í„° ì¸ìŠ¤í„´ìŠ¤ ë°–ìœ¼ë¡œ ì œì–´ê¶Œì„ ë‹¤ì‹œ ì „ë‹¬í•˜ì„¸ìš”.



ì´ ì˜ˆëŠ” `/user/:id` ê²½ë¡œì— ëŒ€í•œ GETìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ ì„œë¸Œ ìŠ¤íƒì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

```javascript
const express = require('express')
const app = express()
const router = express.Router()

// predicate the router with a check and bail out when needed
router.use((req, res, next) => {
  if (!req.headers['x-auth']) return next('router')
  next()
})

router.get('/user/:id', (req, res) => {
  res.send('hello, user!')
})

// use the router and 401 anything falling through
app.use('/admin', router, (req, res) => {
  res.sendStatus(401)
})
```



## <br>Error-handling middleware

>  ì˜¤ë¥˜ ì²˜ë¦¬ ë¯¸ë“¤ì›¨ì–´ëŠ” í•­ìƒ 4ê°œì˜ ì¸ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì˜¤ë¥˜ ì²˜ë¦¬ ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ë¡œ ì‹ë³„í•˜ë ¤ë©´ 4ê°œì˜ ì¸ìˆ˜ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. `next` ê°ì²´ë¥¼ ì‚¬ìš©í•  í•„ìš”ê°€ ì—†ë”ë¼ë„ ì„œëª…ì„ ìœ ì§€í•˜ë ¤ë©´ ì´ë¥¼ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ `next` ê°ì²´ê°€ ì¼ë°˜ ë¯¸ë“¤ì›¨ì–´ë¡œ í•´ì„ë˜ì–´ ì˜¤ë¥˜ë¥¼ ì²˜ë¦¬í•˜ì§€ ëª»í•˜ê²Œ ë©ë‹ˆë‹¤.



3ê°œê°€ ì•„ë‹Œ 4ê°œì˜ ì¸ìˆ˜, íŠ¹íˆ `(err, req, res, next)` ì‹œê·¸ë‹ˆì²˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ì œì™¸í•˜ê³ ëŠ” ë‹¤ë¥¸ ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ì™€ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì˜¤ë¥˜ ì²˜ë¦¬ ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

```javascript
app.use((err, req, res, next) => {
  console.error(err.stack)
  
  res.status(500).send('Something Broke!')
})
```

ì˜¤ë¥˜ ì²˜ë¦¬ ë¯¸ë“¤ì›¨ì–´ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [Error handling](https://expressjs.com/en/guide/error-handling.html)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”!



## <br>Built-in middleware

ë²„ì „ 4.xë¶€í„° ExpressëŠ” ë” ì´ìƒ [Connect](https://github.com/senchalabs/connect)ì— ì˜ì¡´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ì „ì— Expressì— í¬í•¨ë˜ì—ˆë˜ ë¯¸ë“¤ì›¨ì–´ ê¸°ëŠ¥ì€ ì´ì œ ë³„ë„ì˜ ëª¨ë“ˆì— ìˆìŠµë‹ˆë‹¤. ë¯¸ë“¤ì›¨ì–´ ê¸°ëŠ¥ ëª©ë¡ì„ ì°¸ì¡°í•˜ì„¸ìš”.



Expressì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë‚´ì¥ ë¯¸ë“¤ì›¨ì–´ ê¸°ëŠ¥ì´ ìˆìŠµë‹ˆë‹¤.



- [express.static](https://expressjs.com/en/4x/api.html#express.static) serves static assets such as HTML files, images, and so on.(express.staticì€ HTML íŒŒì¼, ì´ë¯¸ì§€ ë“±ê³¼ ê°™ì€ ì •ì  ìì‚°ì„ ì œê³µí•©ë‹ˆë‹¤.)
- [express.json](https://expressjs.com/en/4x/api.html#express.json) parses incoming requests with JSON payloads. **NOTE: Available with Express 4.16.0+**(express.jsonì€ JSON í˜ì´ë¡œë“œë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ êµ¬ë¬¸ ë¶„ì„í•©ë‹ˆë‹¤. ì°¸ê³ : Express 4.16.0+ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
- [express.urlencoded](https://expressjs.com/en/4x/api.html#express.urlencoded) parses incoming requests with URL-encoded payloads. **NOTE: Available with Express 4.16.0+**(express.urlencodedëŠ” URL ì¸ì½”ë”© í˜ì´ë¡œë“œë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ êµ¬ë¬¸ ë¶„ì„í•©ë‹ˆë‹¤. ì°¸ê³ : Express 4.16.0+ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)



## <br>Third-party middleware

 íƒ€ì‚¬ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ Expressì•±ì— ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ì„¸ìš”.

í•„ìš”í•œ ê¸°ëŠ¥ì„ ìœ„í•´ Node.js ëª¨ë“ˆì„ ì„¤ì¹˜í•œ ë‹¤ìŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ì¤€ ë˜ëŠ” ë¼ìš°í„° ìˆ˜ì¤€ì—ì„œ ì•±ì— ë¡œë“œí•©ë‹ˆë‹¤. 

ë‹¤ìŒ ì˜ˆì œì—ì„œëŠ” ì¿ í‚¤ êµ¬ë¬¸ ë¶„ì„ ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ì¸ `cookie-parser`ë¥¼ ì„¤ì¹˜í•˜ê³  ë¡œë“œí•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ì¤ë‹ˆë‹¤. 

```javascript
const express = require('express')
const app = express()
const cookieParser = require('cookie-parser')

// load the cookie-parsing middleware
app.use(cookieParser())
```

